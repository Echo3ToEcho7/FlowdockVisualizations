<script type="text/javascript">
  //var vis = angular.module('fdvis.totalByUsers', ['fdvis']);

function TotalsByUserController($scope, $q, dataFlows) {
  var
    usersByID,
    normalizedData,
    width = $('#chart').width() - 20,
    height = width,
    format = d3.format(",d"),
    color = d3.scale.category20c();

  $scope.loading = true;

  $q.all({
    users: dataFlows.getAllUsers(),
    messages: dataFlows.getActiveFlow().then(function (f) { return f.messages(); })
  }).then(function (res) {
    usersByID = _.indexBy(res.users, 'id');
    usersTotalMessages = _(res.messages)
      .filter(function (m) { return (new Date(m.sent) > new Date(2014, 2, 14)); })
      .filter(function (m) { return m.event === 'message'; })
      .filter(function (m) { return usersByID[m.user].nick !== 'Tye'; })
      .groupBy('user').value();
  console.log(usersTotalMessages);

  normalizedData = _(usersTotalMessages).transform(function (result, messages, user) {
    if (usersByID[user]) {
      result[usersByID[user].nick] = {
        value: messages.length,
        username: usersByID[user].nick
      };
    }
  }).map(function (val) { return val; }).value();

  var bubble = d3.layout.pack()
    .sort(null)
    .size([width, height])
    .padding(1.5);

  var svg = d3.select("#chart").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "bubble");

  d3.select(self.frameElement).style("height", height + "px");

  var node = svg.selectAll(".node")
      .data(bubble.nodes({children: normalizedData})
      .filter(function (d) { return !d.children; }))
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  node.append("title")
    .text(function(d) { return d.username + ": " + format(d.value); });

  node.append("circle")
    .attr("r", function(d) { return d.r; })
    .style("fill", function(d) { return color(d.value); });

  node.append("text")
    .attr("dy", ".3em")
    .style("text-anchor", "middle")
    .text(function(d) { return d.username.substring(0, d.r / 3); });

    $scope.loading = false;
  });

}
</script>
<section class="content-header">
    <h1>
      Total Started by Users During TAM Experiment
    </h1>
    <ol class="breadcrumb">
      <li><a href="#"><i class="fa fa-bar-chart-o"></i> Users</a></li>
        <li class="active">Total Started by User During TAM Experiment</li>
    </ol>
</section>
<section class="content"  data-ng-controller="TotalsByUserController">
  <div class="box box-primary box-default">
    <div class="box-header">
      <div class="box-title">Chart</div>
    </div>
    <div class="box-body">
      <div id="chart" style="min-height: 300px"></div>
    </div>
    <div class="overlay" data-ng-show="loading"></div>
    <div class="loading-img" data-ng-show="loading"></div>
  </div>
</section>
