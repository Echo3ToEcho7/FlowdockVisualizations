<style>
  #tooltip {
    color: white;
    opacity: .9;
    background: #333;
    padding: 5px;
    border: 1px solid lightgrey;
    border-radius: 5px;
    position: absolute;
    z-index: 10;
    visibility: hidden;
    white-space: nowrap;
    pointer-events: none;
  }
  #circle circle {
    fill: none;
    pointer-events: all;
  }
  path.group {
    fill-opacity: .8;
  }
  path.chord {
    fill-opacity: .8;
    stroke: #000;
    stroke-width: .25px;
  }
  #circle:hover path.fade {
    display: none;
  }
</style>
<script type="text/javascript">
  function RespondsToController($scope, $q, dataFlows) {
    var
    usersByID,
    matrix,
    messagesByID,
    commentsByUser,
    numComments,
    userIDsInFlow,
    userList,
    userObjects,

    dataPromise,
    usersPromise;

    $scope.loading = true;

    usersPromise = dataFlows.getAllUsers();
    dataPromise = dataFlows.getActiveFlow().then(function (f) { console.log(f); return f.all(); });


    $q.all({users: usersPromise, data: dataPromise}).then(function (res) {
      matrix = [];

      userIDsInFlow = _(res.data)
        .map(function (m) { return parseInt(m.user + '', 10); })
        .unique()
        .value();
      usersByID = _(res.users).filter(function (u) { return _.contains(userIDsInFlow, u.id); }).indexBy('id').value();
      userList = _.map(usersByID, function (u) { return u.id; });
      userObjects = _.map(userList, function (u) { return usersByID[u]; });

      messagesByID = _(res.data)
        .filter(function (m) { return m.event === 'message'; })
        .indexBy('id')
        .value();

      numComments = _(res.data)
        .filter(function (m) { return m.event === 'comment'; })
        .value().length;

      commentsByUser = _(res.data)
        .filter(function (m) { return m.event === 'comment'; })
        .groupBy(function (m) { return m.user; })
        .value();

      _.each(userList, function (u, idx) {
        var row = _.map(userList, function () { return 0; });
        var list = commentsByUser[u];

        _.each(list, function (c) {
          var mid = _(c.tags).filter(function (t) { return t.indexOf('influx:') !== -1; }).map(function (t) { return t.split(':')[1]; }).first();
          var m = messagesByID[parseInt(mid + '', 10)];
          if (!m) { 
            console.info('Message not found', mid);
            return;
          }

          var i = _.indexOf(userList, parseInt(m.user + '', 10));
          if (i >= 0) {
            row[i] = row[i] + (1 / numComments);
          }
        });

        matrix.push(row);
      });

      console.log(matrix);

      var w = $('#chart').width() - 20, h = w, r1 = h / 2, r0 = r1 - 110;
      var color = d3.scale.category20c();
      var lastIndex = -1;

      var chord = d3.layout.chord()
        .padding(.02)
        .sortSubgroups(d3.descending)
        .sortChords(d3.descending);

      var arc = d3.svg.arc()
        .innerRadius(r0)
        .outerRadius(r0 + 20);

      var svg = d3.select("#chart").append("svg:svg")
        .attr("width", w)
        .attr("height", h)
        .append("svg:g")
        .attr("id", "circle")
        .attr("transform", "translate(" + w / 2 + "," + h / 2 + ")");

      svg.append("circle")
        .attr("r", r0 + 20);

      chord.matrix(matrix);

      var g = svg.selectAll("g.group")
        .data(chord.groups())
      .enter().append("svg:g")
        .attr("class", "group")
        .on("mouseover", mouseover)
        .on("mouseout", mouseout);

      g.append("svg:path")
        .style("stroke", "grey")
        .style("fill", function(d, i) { return color(userObjects[i] ? userObjects[i].nick: ''); })
        .attr("d", arc);

      g.append("svg:text")
        .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
          .attr("dy", ".35em")
          .style("font-family", "helvetica, arial, sans-serif")
          .style("font-size", "9px")
          .attr("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
          .attr("transform", function(d) {
            return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
            + "translate(" + (r0 + 26) + ")"
            + (d.angle > Math.PI ? "rotate(180)" : "");
          })
          .text(function(d, i) { return (userObjects[i] ? userObjects[i].nick : ''); });

      var chordPaths = svg.selectAll("path.chord")
        .data(chord.chords())
      .enter().append("svg:path")
        .attr("class", "chord")
        .style("stroke", "grey")
        .style("fill", function(d, i) { return color((userObjects[i] ? userObjects[i].nick : '')); })
        .attr("d", d3.svg.chord().radius(r0))
        .on("mouseover", function (d, i) {
          d3.select("#tooltip")
            .style("visibility", "visible")
            .html(chordTip(d))
            .style("top", function () { return (d3.event.pageY - 100)+"px"})
            .style("left", function () { return (d3.event.pageX - 100)+"px";})

          console.log('mouseover');
          chordPaths.classed("fade", function(p) {
            return (p.source.index !== lastIndex && p.target.index !== lastIndex);
          });
        })
        .on("mouseout", function (d) { d3.select("#tooltip").style("visibility", "hidden") });

      function chordTip (d) {
        var p = d3.format(".1%"), q = d3.format(",.2r")
        return "Response Info:<br/>"
          +  userObjects[d.source.index].nick + " → " + userObjects[d.target.index].nick
          + ": " + p(d.source.value) + "<br/>"
          + userObjects[d.target.index].nick + " → " + userObjects[d.source.index].nick
          + ": " + p(d.target.value) + "<br/>";
      }

      function groupTip (d) {
        var p = d3.format(".1%"), q = d3.format(",.2r")
        return "User Info:<br/>"
          + userObjects[d.index].nick + " : " + p(d.value) + "<br/>";
      }

      function mouseover(d, i) {
        lastIndex = i;
        d3.select("#tooltip")
          .style("visibility", "visible")
          .html(groupTip(d))
          .style("top", function () { return (d3.event.pageY - 80)+"px"})
          .style("left", function () { return (d3.event.pageX - 130)+"px";})

        chordPaths.classed("fade", function(p) {
          return !(p.source.index === i ||  p.target.index === i);
        });
      }

      function mouseout(d, i) {
        d3.select("#tooltip").style("visibility", "hidden"); 
        chordPaths.classed("fade", function(p) {
          //console.log(p.source.index !== i && p.target.index !== i, p.source.index, p.target.index, i);
          return false;
          //return (p.source.index !== i && p.target.index !== i);
        });
      }

      $scope.loading = false;
    });
  }
</script>
<div id="tooltip"></div>
<section class="content-header">
  <h1>
    Responses
  </h1>
  <ol class="breadcrumb">
    <li><a href="#"><i class="fa fa-bar-chart-o"></i> Conversations</a></li>
    <li class="active">Responses</li>
  </ol>
</section>
<section class="content"  data-ng-controller="RespondsToController">
  <div class="box box-primary box-default">
    <div class="box-header">
      <div class="box-title">Chart</div>
    </div>
    <div class="box-body">
      <div id="chart" style="min-height: 300px"></div>
    </div>
    <div class="overlay" data-ng-show="loading"></div>
    <div class="loading-img" data-ng-show="loading"></div>
  </div>
</section>
